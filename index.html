<html>
<head>
    <script>setInterval(function() { console && console.log("hi brenna"); }, 20 * 1000);</script>
    <link href="main.css" rel="stylesheet" type="text/css" media="all">
</head>
<body>
<a href="#" onclick="stopGame();">Stop Game</a>
<div id="board_container">Loading...</div>

<script type="application/javascript">
    ROWS = 20;
    COLS = 10;
    activeTetramino = null;
    board = null;

    tetraminoTemplates = [
        {
            name: "I",
            shape: [[0, 0], [1, 0], [2, 0], [3, 0]],
            color: "cyan"
        },
        {
            name: "J",
            shape: [[0, 1], [1, 1], [2, 1], [2, 0]],
            color: "blue"
        },
        {
            name: "L",
            shape: [[0, 0], [1, 0], [2, 0], [2, 1]],
            color: "orange"
        },
        {
            name: "S",
            shape: [[1, 0], [1, 1], [0, 1], [0, 2]],
            color: "lime"
        },
        {
            name: "Z",
            shape: [[0, 0], [0, 1], [1, 1], [1, 2]],
            color: "red"
        },
        {
            name: "T",
            shape: [[0, 0], [0, 1], [0, 2], [1, 1]],
            color: "purple"
        },
        {
            name: "O",
            shape: [[0, 0], [0, 1], [1, 0], [1, 1]],
            color: "yellow"
        }

    ];

    function createBoard(rows, cols) {
        var boardID = document.getElementById("board_container");
        var content = "";
        board = [];

        for (var row = 0; row < rows; row++) {
            content = content + "<div>";
            board[row] = [];
            for (var col = 0; col < cols; col++) {
                setBlock(row, col, false);
                content = content + "<div id='block_" + row + "_" + col + "' class='block'>" + row + ", " + col + "</div>"
            }
            content = content + "</div>";
        }
        boardID.innerHTML = content;
    }

    function getBlock(row, col) {
        return board[row][col];
    }

    function setBlock(row, col, value) {
        board[row][col] = value;
    }

    function cloneTetramino() {
        var rand = Math.floor(Math.random() * tetraminoTemplates.length);
        var templateTetramino = tetraminoTemplates[rand];
        var copy = {};

        for (var item in templateTetramino) {
            if (templateTetramino.hasOwnProperty(item)) {

                if (templateTetramino[item] instanceof Array) {

                    var temp = [];

                    for(var i = 0; i < templateTetramino[item].length;i++) {

                        var temp2 = [];
                        for (var j = 0; j < templateTetramino[item][i].length; j++) {
                            temp2[j] = templateTetramino[item][i][j];
                        }
                        temp[i] = temp2;
                    }
                    copy[item] = temp;

                } else {
                    copy[item] = templateTetramino[item];
                }
            }
        }
        return copy;
    }

    function draw(tetramino, action) {
        for (var i = 0; i < tetramino.shape.length; i++) {
            var row = (tetramino.shape[i][0]);
            var col = tetramino.shape[i][1];
            var blockid = "block_" + row + "_" + col;
            if (action == 'fill') {
                var classname = "block active " + tetramino.color;
            } else {
                var classname = "block active black";
            }
            document.getElementById(blockid).setAttribute("class", classname);
        }
    }

    function canMove(tetramino,direction) {
        for(var i = 0; i < tetramino.shape.length;i++){
            if(direction == "down") {
                if((tetramino.shape[i][0] >= ROWS-1) || (getBlock(tetramino.shape[i][0]+1, tetramino.shape[i][1]) == true)) {
                    return false;
                }
            }
        }
        return true;
    }

    function move(tetramino,r) {
        draw(tetramino,"empty");
        for (var i = 0; i < tetramino.shape.length; i++) {
            tetramino.shape[i][0] = tetramino.shape[i][0] + r;
        }
    }

    function place(tetramino) {
        for (var i = 0; i < tetramino.shape.length; i++) {
            setBlock(tetramino.shape[i][0],tetramino.shape[i][1],true);
        }
    }

    function tick() {
            //debugger;
            if (activeTetramino == null) {
                activeTetramino = cloneTetramino();
            }
            if (canMove(activeTetramino,"down")) {
                move(activeTetramino,1);
            } else {
                place(activeTetramino);
                activeTetramino = cloneTetramino();
                console.log(activeTetramino);
            }
            draw(activeTetramino,"fill");
    }

    function stopGame() {
        clearInterval(start);
    }

    createBoard(ROWS, COLS);
    var start = window.setInterval(tick, 100);
</script>

</body>
</html>