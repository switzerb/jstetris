<html>
<head>
    <script>setInterval(function() { console && console.log("hi brenna"); }, 20 * 1000);</script>
    <link href="main.css" rel="stylesheet" type="text/css" media="all">
    <script src="tetraminoTemplates.js"></script>
</head>
<body>
<a href="#" onclick="stopGame();">Stop Game</a>
<div id="board_container">Loading...</div>

<script type="application/javascript">
    ROWS = 20;
    COLS = 10;
    activeTetramino = null;
    board = null;

    function Tetramino(template) {
        this.name = template.name;
        this.color = template.color;
        this.shapes = [];

        for(var i = 0; i < template.shapes.length; i++) {
            this.shapes[i] = template.shapes[i].slice(0);
            for(var j = 0; j < template.shapes[i].length; j++) {
                this.shapes[i][j] = template.shapes[i][j].slice(0);
            }
        }
    }

    // functionality: moves the tetramino one step down, right or left
    // parameter: takes a row and a column to indicate the coordinates of where the tetramino is moving
    // returns: void
    Tetramino.prototype.move = function (r,c) {
        draw(this,"empty");
        for (var i = 0; i < this.shapes[0].length; i++) {
            this.shapes[0][i][0] = this.shapes[0][i][0] + r;
            this.shapes[0][i][1] = this.shapes[0][i][1] + c;
        }
    };

    // functionality: checks to see if a tetramino can move down, right or left
    // parameter: takes a direction that the tetramino is trying to move
    // returns: boolean that indicates whether the tetramino can move that direction or not
    Tetramino.prototype.canMove = function (direction) {
        for(var i = 0; i < this.shapes[0].length; i++){
            if(direction == "down") {
                if((this.shapes[0][i][0] >= ROWS-1) || (getBlock(this.shapes[0][i][0]+1, this.shapes[0][i][1]) == true)) {
                    return false;
                }
            } else if (direction == "right") {
                if((this.shapes[0][i][1] >= COLS-1) || (getBlock(this.shapes[0][i][0], this.shapes[0][i][1]+1) == true)) {
                    return false;
                }
            } else if (direction == "left") {
                if((this.shapes[0][i][1] <= 0) || (getBlock(this.shapes[0][i][1], this.shapes[0][i][1]-1) == true)) {
                    return false;
                }
            }
        }
        return true;
    };

    // functionality: marks the tetramino as locked into place so that no other tetramino can go there
    // parameter: none
    // returns: none
    Tetramino.prototype.place = function() {
        draw(this,"fill");
        for (var i = 0; i < this.shapes[0].length; i++) {
            setBlock(this.shapes[0][i][0],this.shapes[0][i][1],true);
        }
    }


    function createBoard(rows, cols) {
        var boardID = document.getElementById("board_container");
        var content = "";
        board = [];

        for (var row = 0; row < rows; row++) {
            content = content + "<div>";
            board[row] = [];
            for (var col = 0; col < cols; col++) {
                setBlock(row, col, false);
                content = content + "<div id='block_" + row + "_" + col + "' class='block'>" + row + ", " + col + "</div>"
            }
            content = content + "</div>";
        }
        boardID.innerHTML = content;
    }

    function getBlock(row, col) {
        return board[row][col];
    }

    function setBlock(row, col, value) {
        board[row][col] = value;
    }

    function draw(tetramino, action) {
        for (var i = 0; i < tetramino.shapes[0].length; i++) {
            var row = (tetramino.shapes[0][i][0]);
            var col = tetramino.shapes[0][i][1];
            var blockid = "block_" + row + "_" + col;
            if (action == 'fill') {
                var classname = "block active " + tetramino.color;
            } else {
                var classname = "block active black";
            }
            document.getElementById(blockid).setAttribute("class", classname);
        }
    }

    function clearRow(row) {
        if(row > 0) {
            for (var col = 0; col < COLS; col++) {
                var row_up = row - 1;
                var fill = getBlock(row_up,col);
                setBlock(row,col,fill);
                var prevblock = "block_" + row_up + "_" + col;
                var block = "block_" + row + "_" + col;
                var classname = document.getElementById(prevblock).getAttribute("class");
                document.getElementById(block).setAttribute("class", classname);
            }

            for(var r = row-1; r > 0; r--){
                var r_up = r - 1;
                for (var c = 0; c < COLS; c++) {
                    var v = getBlock(r_up,c);
                    setBlock(r,c,v);
                    var pblock = "block_" + r_up + "_" + c;
                    var b = "block_" + r + "_" + c;
                    var cname = document.getElementById(pblock).getAttribute("class");
                    document.getElementById(b).setAttribute("class", cname);
                }
            }

        }
    }

    function checkBoard() {
        for(var row = 0; row < board.length; row++) {
            var flag = true;
            for(var col = 0;col < board[row].length; col++){
                if(getBlock(row,col) == false){
                    flag = false;
                }
            }
            if(flag == true){
                clearRow(row);
            }
        }
    }

    function tick() {
            var rand = Math.floor(Math.random() * tetraminoTemplates.length);
            var templateTetramino = tetraminoTemplates[rand];

            if (activeTetramino == null) {
                activeTetramino = new Tetramino(templateTetramino);
            }
            if (activeTetramino.canMove("down")) {
                activeTetramino.move(1,0);
            } else {
                activeTetramino.place();
                checkBoard();
                activeTetramino = new Tetramino(templateTetramino);
                if(!activeTetramino.canMove("down")){
                    console.log("game over");
                    stopGame();
                }
            }
            draw(activeTetramino,"fill");
    }

    function stopGame() {
        clearInterval(start);
    }

    createBoard(ROWS, COLS);
    var start = window.setInterval(tick, 200);

    document.addEventListener("keydown", keyboard);

    function keyboard(e) {
        if(e.key == "ArrowLeft"){
            if(activeTetramino.canMove("left")){
                activeTetramino.move(0,-1);
            }
        } else if (e.key == "ArrowRight") {
            if(activeTetramino.canMove("right")) {
                activeTetramino.move(0, 1);
            }
        } else if (e.key == "ArrowUp") {
            console.log("rotate left");
        } else if (e.key == "ArrowDown") {
            console.log("rotate right");
        }
    }

</script>

</body>
</html>